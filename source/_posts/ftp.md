---
title: FTP协议工作原理
type: system
description: FTP协议有主动模式 和被动模式之分，那么这两种模式有什么区别？ 各个模式的应用场景是什么样的？ 使用中有哪些注意事项？ 本文主要对这些问题进行详解。
date: 2020-06-22 19:10:42
---

# FTP协议知识点详解

FTP的工作原理是什么样的？另外，FTP协议有 **主动模式** 和 **被动模式** 之分，那么这两种模式有什么区别？ 各个模式的应用场景是什么样的？ 使用中有哪些注意事项？ 本文主要对这些问题进行详解。

## FTP协议工作原理

首先需明白FTP的基本原理
1. FTP分 客户端 （client） 和 服务端 （server）
2. FTP传输过程，分为 控制面 和 数据面

FTP工作原理

1. ftp server监听知名端口 21
2. ftp client向 server的21端口发起tcp连接
3. client和server建立连接后，会协商出一个用于数据面传输的连接方式（即：**主动模式** 还是 **被动模式**）
4. 如何协商呢？ 下面介绍

> 何谓主动模式？
> 主动模式的意思是，client 主动监听一个TCP端口，告知server，然后server向client这个端口发起连接，最终使用这个连接进行数据的传输

> 何谓被动模式？
> 被动模式的意思是，server 主动监听一个TCP端口，告知client，然后client向server这个端口发起连接，最终使用这个连接进行数据的传输

5. 协商过程
    * 主动模式协商：client 向server发送命令 `PORT x,x,x,x,p,p` 其中，`x` 是 client 的IP四个字节的每个字节值，用 `,`隔开， `p`是监听的端口两个字节的每个字节值也用 `,` 隔开 
    * 被动模式协商：client 向server发送命令 `PASV` 或者 `passive` （不同ftp客户端这个命令可能不一向，使用linux命令ftp的话 应该使用 **passive**），然后server 收到命令后会给client回复 ip和端口 ,类似于主动模式的格式用逗号隔开
6. 协商完成后，根据client 和 server会通过协商的模式简历连接
7. 后面再进行文件的上传下载的话，用到都是数据面的连接

## 应该使用主动 还是 被动模式？

解答这个问题，可以先思考如下组网环境的话，如果是 **主动模式** 终端还能向 FTP服务器上传、下载吗？

![FTP组网](/images/ftp_net.png)

图例组网模式:

1. 终端通过 NAT网关 连接互联网
2. 终端在NAT网关上获取192.168.1.x/24 的IP地址
3. FTP服务器在互联网的另一侧
4. 这种环境下 终端通过 **主动模式** 的话那么还能和FTP服务器连接吗？

思考？

1. 首先，终端是在内网环境，FTP是在外网环境，两者不在同一网段。
2. **主动模式** 下，假如 终端在FTP数据面监听了 `192.168.1.10:30009` ，向 server 发送命令 `PORT 192,168,1,10,p,p` (p的值我就不计算了)
3. 此时ftp server收到后，会向 `192.168.1.10:30009`发起连接吗？
4. 事实上是不会的
5. ftp server 会直接通过控制面，向终端发送一个报文 **500 Illegal PORT command.**
6. 告知终端 `无效的命令`

为什么 会出现 **500 Illegal PORT command.** ?

1. 这个问题我遇到后也很是头疼，不过当我看了 vsftpd的源码后，找到了答案
2. 在 **vsftpd-3.0.3** 源码 `postlogin.c` 函数 `handle_port` 找到答案
3. 没猜错的话，这个函数 `handle_port` 是来解析 `PORT` 命令的 ，如图：

![vsftp源码截图](/images/vsftpd.png)

4. 图中 方框 函数，比较了 `PORT` 命令发送的IP地址 和 控制面连接 IP地址 是否相同？
5. 如果不相同的话，那么就会回复 `500 Illegal PORT command.`
6. 这样就能解释一切了

那么这种组网真的就不能使用 **主动模式** 了吗？

1. 答案是否定的
2. 只要组网中的 **NAT网关** 支持 **NAT-FTP**功能就可以了

如何支持 **NAT-FTP**功能呢？

1. 例如，如果 NAT网关是 LINUX操作系统（作者测试环境是CentOS-7），只要加载内核模块 **nf_nat_ftp** 就可以了
   
    modprobe nf_nat_ftp

2. 其它系统的话就看是否支持了，我想应该都有支持的方法的，我这里没有做研究。

为什么加载 **nf_nat_ftp** 后就可以了呢？

1. 这个问题我没有看源码，但我的理解如下
2. 内核模块 **nf_nat_ftp** 会侦听 FTP协议报文
3. 当检测到**主动模式** 协商报文时，还记得上面主动模式协商的命令 `PORT x,x,x,x,p,p`
4. **nf_nat_ftp** 会把报文中的 `IP` 和 `port` 都替换掉
5. `IP`会被替换成NAT网关的出口IP，然后NAT网关自己会开启一个监听端口 把 `port`替换掉
6. 这样的话，FTP服务器的数据面实际上是跟NAT网关建立了连接
7. 当然，NAT网关需要维护一个映射关系，会把收到的FTP服务器的数据面报文都再转发给终端
8. 这样就完成了 **主动模式** 的传输
